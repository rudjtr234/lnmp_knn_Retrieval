# LNMP_KNN_Retrieval

## ğŸ“Œ ê°œìš”
ë³¸ í”„ë¡œì íŠ¸ëŠ” **ìœ ë°©ì•” ë¦¼í”„ì ˆ ì „ì´(LNMP, Lymph Node Metastasis Prediction)** íŒë³„ì„ ìœ„í•´
íƒ€ì¼ ë‹¨ìœ„ ì„ë² ë”©ì„ í™œìš©í•œ **KNN ê¸°ë°˜ Retrieval ì•Œê³ ë¦¬ì¦˜**ì„ êµ¬í˜„í•œ ê²ƒì…ë‹ˆë‹¤.

- ì…ë ¥: 512 x 512 ë³‘ë¦¬ íƒ€ì¼ (WSI ê¸°ë°˜)
- ì„ë² ë”© ëª¨ë¸: **UNI2-h (ViT-H/14, 1536ì°¨ì›)**
- ë²¡í„° ê²€ìƒ‰: **FAISS k-NN (Ï„ = 99.99% ë¶„ìœ„ìˆ˜ ì„ê³„ì¹˜ ì ìš©)**
- ìµœì¢… íŒì •: ë‹¤ìˆ˜ê²° ê¸°ë°˜ íˆ¬í‘œ(KNN_VOTE)ë¡œ ìŠ¬ë¼ì´ë“œ ë‹¨ìœ„ **Non-metastasis ì—¬ë¶€** íŒì •

---

## ğŸ–¼ ì•Œê³ ë¦¬ì¦˜ ê°œìš” ë‹¤ì´ì–´ê·¸ë¨
![LNMP KNN Retrieval](./image/lnmp_knn_retrieval.png)

---

## ğŸ§© ì•Œê³ ë¦¬ì¦˜ ì ˆì°¨
1. **Tile Extraction**: 512Ã—512 í¬ê¸°ì˜ WSI íƒ€ì¼ ì¶”ì¶œ
2. **Embedding**: UNI2-h ëª¨ë¸ë¡œ 1536ì°¨ì› ë²¡í„°í™”
3. **Indexing**: ChromaDB ë° FAISS GPU index êµ¬ì¶•
4. **Thresholding (Fence ì„¤ì •)**:
   - ìƒìœ„ ë¶„ìœ„ìˆ˜(Ï„_high, ì˜ˆ: 99.97% ~ 99.93%) â†’ **Fence ë°– â†’ META í™•ì •**
   - í•˜ìœ„ ë¶„ìœ„ìˆ˜(Ï„_low=98%) â†’ **Fence ì•ˆ â†’ NON-META í™•ì •**
   - Ï„_low â‰¤ dist â‰¤ Ï„_high â†’ **ì• ë§¤ êµ¬ê°„ â†’ KNN íˆ¬í‘œ ì§„í–‰**
5. **Retrieval & Voting**:
   - Query íƒ€ì¼ì— ëŒ€í•´ FAISS L2 ê±°ë¦¬ ê¸°ë°˜ ìµœê·¼ì ‘ k=5 ì´ì›ƒ íƒìƒ‰
   - **5-NN ë§Œì¥ì¼ì¹˜ ê·œì¹™** ì ìš© â†’ ì´ì›ƒ ëª¨ë‘ fence ë°–ì¼ ê²½ìš° META íŒì •
6. **Slide-level Aggregation**:
   - META íƒ€ì¼ ë¹„ìœ¨ â‰¥ **0.005**  
   - META íƒ€ì¼ ê°œìˆ˜ â‰¥ **10**  
   â†’ ì¡°ê±´ ë§Œì¡± ì‹œ ìŠ¬ë¼ì´ë“œ ì „ì²´ë¥¼ **Metastasis(ì „ì´)**ë¡œ ìµœì¢… íŒì •
---

## ğŸ“Š Prediction Report ì˜ˆì‹œ
```json
[
  {
    "id": "BC_01_0001.svs",
    "metastasis": 1
  },
  {
    "id": "BC_01_0003.svs",
    "metastasis": 1
  },
  {
    "id": "BC_01_0004.svs",
    "metastasis": 1
  }
]

```

---

## ğŸ“Š ê²°ê³¼(2025_09_16) 

| ë²„ì „     | VectorDB ê·œëª¨ | Ï„ ì„¤ì •(Quantile) | Accuracy  | Precision | Recall (Sensitivity) | Specificity | F1-score  |
| ------ | ----------- | -------------- | --------- | --------- | -------------------- | ----------- | --------- |
| v0.2.7 | ~138ë§Œ íƒ€ì¼   | Ï„=99.97% / 98% | **0.640** | **0.769** | **0.400**            | **0.880**   | **0.526** |
| v0.2.8 | ~138ë§Œ íƒ€ì¼   | Ï„=99.94% / 98% | **0.560** | **0.552** | **0.640**            | **0.480**   | **0.593** |
| v0.2.9 | ~138ë§Œ íƒ€ì¼   | Ï„=99.93% / 98% | **0.560** | **0.545** | **0.720**            | **0.400**   | **0.621** |


ğŸ”¹ Confusion Matrix

ğŸ“Œ v0.2.7

|                     | Predicted Positive (Meta) | Predicted Negative (Non-Meta) |
| ------------------- | ------------------------- | ----------------------------- |
| **Actual Positive** | 22 (TP)                   | 3 (FN)                        |
| **Actual Negative** | 25 (FP)                   | 0 (TN)                        |

ğŸ“Œ v0.2.8

|                     | Predicted Positive (Meta) | Predicted Negative (Non-Meta) |
| ------------------- | ------------------------- | ----------------------------- |
| **Actual Positive** | 16 (TP)                   | 9 (FN)                        |
| **Actual Negative** | 11 (FP)                   | 14 (TN)                       |

ğŸ“Œ v0.2.9

|                     | Predicted Positive (Meta) | Predicted Negative (Non-Meta) |
| ------------------- | ------------------------- | ----------------------------- |
| **Actual Positive** | 18 (TP)                   | 7 (FN)                        |
| **Actual Negative** | 15 (FP)                   | 10 (TN)                       |
